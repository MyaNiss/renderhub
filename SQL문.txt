-- 1. 사용자 역할 테이블 (user_role)
CREATE TABLE user_role (
    role_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '역할 고유 ID',
    name VARCHAR(50) NOT NULL UNIQUE COMMENT '역할 이름 (USER, ADMIN)'
);

show tables like 'user_role';

-- 2. 사용자 계정 테이블 (user) - Soft Delete 적용
CREATE TABLE user_account (
    user_id VARCHAR(50) PRIMARY KEY COMMENT '사용자 고유 ID (접속 ID)',
    role_id BIGINT NOT NULL COMMENT '사용자의 역할 ID',
    password VARCHAR(255) NOT NULL COMMENT '해시된 비밀번호',
    name VARCHAR(30) not null COMMENT '이름',
    nickname VARCHAR(30) NOT NULL COMMENT '사용자 닉네임',
    phone VARCHAR(20) COMMENT '휴대폰 번호',
    email VARCHAR(50) NOT NULL UNIQUE COMMENT '이메일',
    contents TEXT DEFAULT '' COMMENT '개인 소개 내용',
    regist_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '가입일시',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT '논리적 삭제 여부',
    deleted_at DATETIME NULL COMMENT '탈퇴/삭제 일시',

    FOREIGN KEY (role_id) REFERENCES user_role(role_id)
);

-- 3. 사용자 정산 정보 테이블 (user_bank) - PK 겸 FK
CREATE TABLE user_bank (
    user_id VARCHAR(50) PRIMARY KEY COMMENT '사용자 ID (PK 겸 FK)',
    bank_name VARCHAR(50) NOT NULL COMMENT '은행명',
    account_number VARCHAR(100) NOT NULL COMMENT '계좌 번호',
    account_holder VARCHAR(50) NOT NULL COMMENT '예금주명',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '생성 일시',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() ON UPDATE CURRENT_TIMESTAMP() COMMENT '정보 최종 수정일',

    FOREIGN KEY (user_id) REFERENCES user_account(user_id)
);

-- 4. 공통 카테고리 테이블 (category)
CREATE TABLE category (
    category_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '카테고리 고유 ID',
    category_type VARCHAR(30) NOT NULL COMMENT '분류 기준 (POST_PRODUCT, CS_CATEGORY 등)',
    name VARCHAR(50) NOT NULL COMMENT '카테고리 이름',

    UNIQUE KEY uk_type_name (category_type, name)
);

-- 5. 3D 파일 상품 테이블 (post) - Soft Delete, 조회수, 구매수 추가
CREATE TABLE post (
    post_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '상품 고유 ID',
    writer_id VARCHAR(50) NOT NULL COMMENT '작성자 ID',
    category_id BIGINT NOT NULL COMMENT '상품 분류 카테고리 ID',
    file_type_id BIGINT NOT NULL COMMENT '상품 파일 형식 ID',
    title VARCHAR(100) NOT NULL COMMENT '제목',
    content TEXT NOT NULL COMMENT '본문 (Quill 내용)',
    price BIGINT NOT NULL COMMENT '판매 가격',
    view_count INT NOT NULL DEFAULT 0 COMMENT '조회수',
    purchase_count INT NOT NULL DEFAULT 0 COMMENT '품목 구매 수',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '생성 일시',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() ON UPDATE CURRENT_TIMESTAMP() COMMENT '최종 수정일',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT '논리적 삭제 여부',
    deleted_at DATETIME NULL COMMENT '삭제 일시',

    FOREIGN KEY (writer_id) REFERENCES user_account(user_id),
    FOREIGN KEY (category_id) REFERENCES category(category_id),
    FOREIGN KEY (file_type_id) REFERENCES category(category_id)
);

-- 6. 게시판 및 CS 테이블 (article) - Hard Delete 유지, 조회수 추가
CREATE TABLE article (
    article_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '게시글 고유 ID',
    writer_id VARCHAR(50) NOT NULL COMMENT '작성자 ID',
    article_type varchar(10) not null comment 'BOARD, CS 등 게시판 종류'
    category_id BIGINT NOT NULL COMMENT '카테고리 ID',
    title VARCHAR(100) NOT NULL COMMENT '제목',
    content TEXT NOT NULL COMMENT '본문 (Quill 내용)',
    is_secret BOOLEAN NOT NULL DEFAULT FALSE COMMENT '비밀글 여부',
    view_count INT NOT NULL DEFAULT 0 COMMENT '조회수',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '생성 일시',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() ON UPDATE CURRENT_TIMESTAMP() COMMENT '최종 수정일',

    FOREIGN KEY (writer_id) REFERENCES user_account(user_id),
    FOREIGN KEY (category_id) REFERENCES category(category_id)
);

-- 7. 파일 및 이미지 테이블 (file)
CREATE TABLE file (
    file_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '파일 고유 ID',
    file_use_type VARCHAR(30) NOT NULL COMMENT '파일 사용 용도 (POST_FILE, POST_IMG 등)',
    original_name VARCHAR(255) NOT NULL COMMENT '원본 파일명',
    stored_path VARCHAR(255) NOT NULL COMMENT '서버/S3 저장 경로',
    post_id BIGINT NULL COMMENT '연관된 상품 ID',
    article_id BIGINT NULL COMMENT '연관된 게시글/CS ID',

    FOREIGN KEY (post_id) REFERENCES post(post_id),
    FOREIGN KEY (article_id) REFERENCES article(article_id)
);

-- 8. 댓글 테이블 (comment)
CREATE TABLE comment (
    comment_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '댓글 고유 ID',
    writer_id VARCHAR(50) NOT NULL COMMENT '작성자 ID',
    target_type VARCHAR(10) NOT NULL COMMENT '대상 구분 (POST, ARTICLE)',
    target_id BIGINT NOT NULL COMMENT '대상 ID (post_id 또는 article_id)',
    content VARCHAR(500) NOT NULL COMMENT '댓글 내용',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '생성 일시',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() ON UPDATE CURRENT_TIMESTAMP() COMMENT '최종 수정일',

    FOREIGN KEY (writer_id) REFERENCES user_account(user_id)
);

-- 9. 주문 테이블 (user_order) - 불변 데이터 (updated_at 제거)
CREATE TABLE user_order (
    order_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '주문 고유 ID',
    user_id VARCHAR(50) NOT NULL COMMENT '주문자 ID',
    total_price BIGINT NOT NULL COMMENT '총 결제 금액',
    status VARCHAR(20) NOT NULL DEFAULT 'CREATED' COMMENT '주문 상태',
    toss_order_code VARCHAR(255) NOT NULL UNIQUE COMMENT '토스 결제 연동 ID',
    pg_tid VARCHAR(255) COMMENT 'PG사 발급 거래 ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '주문 일시',

    FOREIGN KEY (user_id) REFERENCES user_account(user_id)
);

-- 10. 장바구니 항목 테이블 (cart_item)
CREATE TABLE cart (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '장바구니 항목 ID',
    user_id VARCHAR(50) NOT NULL COMMENT '장바구니 주인 ID',
    post_id BIGINT NOT NULL COMMENT '담은 상품 ID',

    FOREIGN KEY (user_id) REFERENCES user_account(user_id),
    FOREIGN KEY (post_id) REFERENCES post(post_id),
    UNIQUE KEY uk_user_post (user_id, post_id)
);

-- 11. 주문 항목 테이블 (order_item)
CREATE TABLE order_item (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '주문 항목 ID',
    order_id BIGINT NOT NULL COMMENT '속한 주문 ID',
    post_id BIGINT NOT NULL COMMENT '주문된 상품 ID',
    order_price BIGINT NOT NULL COMMENT '주문 시점의 단가',

    FOREIGN KEY (order_id) REFERENCES user_order(order_id),
    FOREIGN KEY (post_id) REFERENCES post(post_id)
);

-- 12. 사용자 구매 이력 및 다운로드 권한 테이블 (transaction_history) - 불변 데이터 (updated_at 제거)
CREATE TABLE transaction_history (
    user_id VARCHAR(50) NOT NULL COMMENT '구매자 ID',
    post_id BIGINT NOT NULL COMMENT '구매한 상품 ID',
    order_id BIGINT NOT NULL COMMENT '구매를 발생시킨 주문 ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '구매 확정일시',

    PRIMARY KEY (user_id, post_id),
    FOREIGN KEY (user_id) REFERENCES user_account(user_id),
    FOREIGN KEY (post_id) REFERENCES post(post_id),
    FOREIGN KEY (order_id) REFERENCES user_order(order_id)
);